name: Release checksums (SHA256SUMS)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag (e.g. v0.1.0)
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  sha256sums:
    runs-on: ubuntu-latest
    steps:
      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Download release assets
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p release_assets
          gh release download "$TAG" --dir release_assets

      - name: Generate SHA256SUMS
        env:
          TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
        run: |
          set -euo pipefail
          cd release_assets
          rm -f SHA256SUMS SHA256SUMS.sig SHA256SUMS.pem

          : > SHA256SUMS
          find . -maxdepth 1 -type f -printf '%f\n' | sort | while IFS= read -r f; do
            case "$f" in
              SHA256SUMS|SHA256SUMS.*) continue ;;
            esac
            sha256sum "$f" >> SHA256SUMS
          done

      - name: Sign SHA256SUMS (keyless)
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          cd release_assets
          cosign sign-blob --yes \
            --output-signature SHA256SUMS.sig \
            --output-certificate SHA256SUMS.pem \
            SHA256SUMS

      - name: Upload SHA256SUMS + signature
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
        run: |
          set -euo pipefail
          cd release_assets
          gh release upload "$TAG" SHA256SUMS SHA256SUMS.sig SHA256SUMS.pem --clobber
